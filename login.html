<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ProfitPal Login</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#0a0e27 0%,#1e3a5f 50%,#2c5f2d 100%);min-height:100vh;color:#fff;display:flex;align-items:center;justify-content:center}
    .login-container{background:linear-gradient(135deg,rgba(30,58,95,.4),rgba(15,35,65,.6));backdrop-filter:blur(20px);border-radius:20px;padding:40px;border:2px solid rgba(34,139,34,.3);width:90%;max-width:500px;text-align:center}
    .logo,.header-logo{font-size:32px;font-weight:900;background:linear-gradient(135deg,#32cd32,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px}
    .header{position:absolute;top:0;left:0;right:0;padding:20px 30px;display:flex;justify-content:space-between;align-items:center;z-index:100}
    .header-logo{font-size:28px;margin:0}
    .back-link{color:#32cd32;text-decoration:none;font-weight:600;padding:10px 20px;border:2px solid rgba(50,205,50,.3);border-radius:10px;transition:.3s}
    .back-link:hover{background:rgba(50,205,50,.1);border-color:#32cd32}
    .login-title{color:#32cd32;font-size:24px;font-weight:700;margin-bottom:15px}
    .login-subtitle{color:#95a5a6;font-size:16px;margin-bottom:30px;line-height:1.6}
    .form-group{margin-bottom:25px;text-align:left}
    .form-label{display:block;color:#32cd32;margin-bottom:8px;font-weight:600;font-size:14px}
    .form-input{width:100%;padding:15px;background:rgba(44,62,80,.3);border:2px solid rgba(34,139,34,.2);border-radius:10px;color:#fff;font-size:16px}
    .form-input:focus{outline:none;border-color:#32cd32;box-shadow:0 0 0 3px rgba(50,205,50,.1)}
    .form-input::placeholder{color:#87ceeb}
    .form-input[readonly]{background:rgba(50,205,50,.1);border-color:rgba(50,205,50,.3);color:#32cd32;font-weight:600}
    .license-input{font-family:'Courier New',monospace;letter-spacing:1px;text-transform:uppercase}
    .login-btn{background:linear-gradient(135deg,#32cd32,#228b22);color:#fff;border:none;padding:15px 30px;border-radius:12px;font-size:18px;font-weight:600;cursor:pointer;width:100%;transition:.3s;margin-top:10px}
    .login-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(50,205,50,.3)}
    .login-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
    .security-info{margin-top:20px;font-size:13px;color:#95a5a6;opacity:.8}
    .error-message{background:linear-gradient(135deg,rgba(231,76,60,.2),rgba(139,0,0,.1));border:2px solid #e74c3c;border-radius:10px;padding:15px;margin-bottom:20px;color:#e74c3c;display:none}
    .loading{display:none;color:#32cd32;margin-top:15px}
    .spinner{border:2px solid rgba(50,205,50,.3);border-top:2px solid #32cd32;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;display:inline-block;margin-right:10px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .footer{position:absolute;bottom:20px;left:0;right:0;text-align:center;color:#95a5a6;font-size:14px}
    @media (max-width:768px){.header{position:static;margin-bottom:20px;flex-direction:column;gap:15px}.login-container{margin:20px;padding:30px 20px}.footer{position:static;margin-top:30px}}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-logo">üíé ProfitPal</div>
    <a href="/" class="back-link">‚Üê Back to Home</a>
  </div>

  <div class="login-container">
    <h1 class="login-title">üîë Already have ProfitPal? Sign In</h1>
    <p class="login-subtitle">
      Enter your email and license key from the welcome email to access your dashboard.
    </p>

    <div id="errorMessage" class="error-message"></div>

    <form id="loginForm" novalidate>
      <div class="form-group">
        <label class="form-label" for="email">Email Address</label>
        <input type="email" id="email" class="form-input" placeholder="Enter your email address" required>
      </div>

      <div class="form-group">
        <label class="form-label" for="fullName">Full Name (Auto-filled from database)</label>
        <input type="text" id="fullName" class="form-input" placeholder="Will auto-fill when email is recognized" readonly>
      </div>

      <div class="form-group">
        <label class="form-label" for="licenseKey">License Key (<span id="keyFormatLabel">PP-XXXX-XXXX-XXXX</span>)</label>
        <!-- –í–ê–ñ–ù–û: maxlength=17, —á—Ç–æ–±—ã –∫–ª—é—á –≤–ª–µ–∑–∞–ª —Ü–µ–ª–∏–∫–æ–º -->
        <input type="text" id="licenseKey" class="form-input license-input" placeholder="PP-XXXX-XXXX-XXXX" maxlength="17" required>
      </div>

      <!-- Admin Mode -->
      <div class="form-group" style="margin-bottom:25px;">
        <div style="display:flex;align-items:center;gap:10px;background:rgba(44,62,80,.2);padding:15px;border-radius:10px;border:1px solid rgba(255,107,53,.3);">
          <input type="checkbox" id="adminMode" style="transform:scale(1.2);accent-color:#ff6b35;">
          <label for="adminMode" style="color:#ff6b35;font-weight:600;cursor:pointer;">üëë Admin Mode (Different key format)</label>
        </div>
      </div>

      <button type="submit" class="login-btn" id="loginBtn">Access ProfitPal Dashboard ‚Üí</button>

      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        Validating your license key...
      </div>
    </form>

    <div class="security-info">
      üîí Your license key is validated securely and tied to your device fingerprint
    </div>
  </div>

  <div class="footer">
    ¬© 2025 ProfitPal. A product of Denava LLC. All rights reserved.
  </div>

  <script>
    // ===== helpers =====
    const form          = document.getElementById('loginForm');
    const emailInput    = document.getElementById('email');
    const fullNameInput = document.getElementById('fullName');
    const licenseInput  = document.getElementById('licenseKey');
    const adminToggle   = document.getElementById('adminMode');
    const keyLabel      = document.getElementById('keyFormatLabel');
    const errorBox      = document.getElementById('errorMessage');
    const loadingBox    = document.getElementById('loadingState');
    const loginBtn      = document.getElementById('loginBtn');

    const CLIENT_KEY_RE = /^PP-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;

    function showError(msg){ errorBox.textContent=msg; errorBox.style.display='block'; }
    function clearError(){ errorBox.style.display='none'; errorBox.textContent=''; }

    // –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ –∫–ª–∏–µ–Ω—Ç–∞
    function formatClientKey(raw){
      const v = raw.toUpperCase().replace(/[^A-Z0-9]/g,'');
      // –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å PP
      const pref = v.startsWith('PP') ? v : ('PP' + v);
      const body = pref.slice(2, 14); // –¥–æ 12 —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ—Å–ª–µ PP
      let out = 'PP';
      if(body.length>0) out += '-' + body.slice(0,4);
      if(body.length>4) out += '-' + body.slice(4,8);
      if(body.length>8) out += '-' + body.slice(8,12);
      return out;
    }

    // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
    function applyMode(isAdmin){
      if(isAdmin){
        licenseInput.placeholder = 'PP-XX-XXXXXXXX-XXXXXXXX-XXXXXXXX-XXXXXXXX';
        licenseInput.maxLength   = 50;
        keyLabel.textContent     = 'PP-XX-XXXXXXXX-XXXXXXXX-XXXXXXXX-XXXXXXXX';
        licenseInput.value = '';
      }else{
        licenseInput.placeholder = 'PP-XXXX-XXXX-XXXX';
        licenseInput.maxLength   = 17;   // –ö–†–ò–¢–ò–ß–ù–û: –±—ã–ª–æ 16
        keyLabel.textContent     = 'PP-XXXX-XXXX-XXXX';
        licenseInput.value = '';
      }
    }
    applyMode(adminToggle.checked);
    adminToggle.addEventListener('change', e => applyMode(e.target.checked));

    // –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–ª—é—á–∞
    licenseInput.addEventListener('input', () => {
      if(adminToggle.checked) { licenseInput.value = licenseInput.value.toUpperCase(); return; }
      const caret = licenseInput.selectionStart;
      const before = licenseInput.value;
      licenseInput.value = formatClientKey(before);
      try{ licenseInput.setSelectionRange(caret, caret); }catch{}
    });

    // –º—è–≥–∫–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –§–ò–û: —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ email+–∫–ª—é—á –≤–∞–ª–∏–¥–Ω—ã
    let lookupTimer=null;
    function tryAutofillName(){
      clearTimeout(lookupTimer);
      lookupTimer = setTimeout(async ()=>{
        const email = (emailInput.value||'').trim();
        const key   = (licenseInput.value||'').trim().toUpperCase();
        if(!email || !CLIENT_KEY_RE.test(key) || adminToggle.checked){ return; }

        try{
          const r = await fetch('/validate-credentials', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ email, license_key: key })
          });
          const d = await r.json();
          if(r.ok && d.show_name && d.full_name){
            fullNameInput.value = d.full_name;
            fullNameInput.style.color = '#32cd32';
          }else{
            fullNameInput.value = '';
            fullNameInput.style.color = '';
          }
        }catch(e){ /* –º–æ–ª—á–∞ */ }
      }, 250);
    }
    emailInput.addEventListener('blur', tryAutofillName);
    licenseInput.addEventListener('blur', tryAutofillName);

    // üëë ADMIN AUTOFILL - –õ–û–ì–ò–ö–ê "–î–†–£–ì–ê"
    async function adminAutofill() {
      if (!adminToggle.checked) return;
      const email = (emailInput.value || '').trim();
      if (!email) return;

      try {
        const r = await fetch('/api/check-admin-status', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ email, fingerprint: '' })
        });
        const d = await r.json();
        if (r.ok && d.is_admin) {
          fullNameInput.value = d.admin_full_name || 'Administrator';
          fullNameInput.style.color = '#32cd32';
          console.log(`üëë Admin name auto-filled: ${d.admin_full_name}`);
        } else {
          fullNameInput.value = '';
          fullNameInput.style.color = '';
        }
      } catch(e) { 
        console.error('Admin autofill error:', e);
      }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º admin autofill –∫ —Å–æ–±—ã—Ç–∏—è–º
    emailInput.addEventListener('blur', adminAutofill);
    adminToggle.addEventListener('change', adminAutofill);

    // —Å–∞–±–º–∏—Ç ‚Äî —Ä–µ–∞–ª—å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      clearError();

      const email = (emailInput.value||'').trim();
      const license_key = (licenseInput.value||'').trim().toUpperCase();
      const full_name = (fullNameInput.value||'').trim();
      const isAdmin = adminToggle.checked;

      if(!email) return showError('Enter your email.');
      if(!license_key) return showError('Enter your license key.');
      if(!isAdmin && !CLIENT_KEY_RE.test(license_key))
        return showError('License key format should be PP-XXXX-XXXX-XXXX.');

      loadingBox.style.display='block';
      loginBtn.disabled = true;

      try{
        const res = await fetch('/authenticate-user', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, license_key, full_name })
        });
        const data = await res.json();

        if(res.ok && data.success){
          if(data.session_token){
            localStorage.setItem('pp_session', data.session_token);
            localStorage.setItem('pp_email', email);
            localStorage.setItem('pp_user_role', data.user_role || 'client');
          }
          window.location.href = '/dashboard';
        }else{
          showError(data.error || 'Authentication failed.');
        }
      }catch(err){
        console.error(err);
        showError('Network error. Please try again.');
      }finally{
        loadingBox.style.display='none';
        loginBtn.disabled=false;
      }
    });

    // —Ñ–æ–∫—É—Å –Ω–∞ email
    emailInput.focus();
  </script>
</body>
</html>